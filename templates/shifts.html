{% extends "base.html" %}

{% block title %}Shift Patterns - Driver Shift Sheets{% endblock %}

{% block extra_head %}
<style>
.btn-group .btn {
    transition: all 0.3s ease !important;
    transform: scale(1) !important;
}

.btn-group .btn:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 6px 12px rgba(0,0,0,0.3) !important;
    z-index: 10 !important;
    position: relative !important;
}

.btn-primary:hover {
    background-color: #0056b3 !important;
}

.btn-success:hover {
    background-color: #155724 !important;
}

.btn-danger:hover {
    background-color: #721c24 !important;
}

#shiftTypesModal .modal-dialog {
    max-width: 1100px;
}

#shiftTypesModal .modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

@media (max-width: 768px) {
    #shiftTypesModal .modal-dialog {
        max-width: 95%;
        margin: 0.75rem auto;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-calendar-week"></i> Shift Management
    </h1>
</div>

<div id="mainPageFeedback" class="alert d-none" role="alert"></div>

<!-- Shift Types Overview -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-clock"></i> Current Shifts</h5>
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#shiftTypesModal">
                <i class="fas fa-edit"></i> Manage Shifts
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row" id="currentShiftsGrid">
            {% for timing in all_timings %}
            {% set shift_type = timing.shift_type %}
            <div class="col-md-3 current-shift-card" data-shift-type="{{ shift_type }}" data-start-time="{{ timing.start_time.strftime('%H:%M') }}">
                <div class="text-center p-3 border rounded">
                    {% if shift_type == 'earlies' %}
                    <i class="fas fa-sun text-warning fa-2x mb-2"></i>
                    {% elif shift_type == 'days' %}
                    <i class="fas fa-sun text-success fa-2x mb-2"></i>
                    {% elif shift_type == 'lates' %}
                    <i class="fas fa-moon text-info fa-2x mb-2"></i>
                    {% elif shift_type == 'nights' %}
                    <i class="fas fa-moon text-dark fa-2x mb-2"></i>
                    {% else %}
                    <i class="fas fa-clock text-primary fa-2x mb-2"></i>
                    {% endif %}
                    <h6>{{ shift_type.replace('_', ' ').title() }}</h6>
                    <p class="mb-0">
                        <strong>{{ timing.start_time.strftime('%H:%M') }} - {{ timing.end_time.strftime('%H:%M') }}</strong>
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% if patterns %}
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-week"></i> Shift Patterns</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createPatternModal">
                    <i class="fas fa-plus"></i> Create Pattern
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Pattern Name</th>
                            <th>Description</th>
                            <th>Cycle Length</th>
                            <th>Pattern Preview</th>
                            <th>Assigned To</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pattern in patterns %}
                        <tr>
                            <td>
                                <strong>{{ pattern.name }}</strong>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ pattern.description or 'No description' }}
                                </small>
                            </td>
                            <td>
                                <span class="badge bg-dark fs-6">
                                    {{ pattern.cycle_length }} days
                                </span>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-1">
                                    {% set pattern_data = pattern.get_pattern_data() %}
                                    {% set show_count = 14 if pattern.cycle_length > 14 else pattern.cycle_length %}
                                    {% for shift in pattern_data[:show_count] %}
                                        {% if shift == 'day_off' %}
                                            <span class="badge bg-secondary">OFF</span>
                                        {% elif shift == 'earlies' %}
                                            <span class="badge bg-warning">E</span>
                                        {% elif shift == 'days' %}
                                            <span class="badge bg-success">D</span>
                                        {% elif shift == 'lates' %}
                                            <span class="badge bg-info">L</span>
                                        {% elif shift == 'nights' %}
                                            <span class="badge bg-dark">N</span>
                                        {% else %}
                                            <span class="badge bg-primary" title="{{ shift.replace('_', ' ').title() }}">
                                                {{ shift.replace('_', ' ')[:2].upper() }}
                                            </span>
                                        {% endif %}
                                    {% endfor %}
                                    {% if pattern.cycle_length > 14 %}
                                        <span class="text-muted">...+{{ pattern.cycle_length - 14 }} more</span>
                                    {% endif %}
                                </div>
                                <small class="text-muted d-block mt-1">
                                    E=Earlies, D=Days, L=Lates, N=Nights, OFF=Rest Day, Custom=2 letters
                                </small>
                            </td>
                            <td>
                                {% set assigned_drivers = pattern.get_unique_assigned_drivers_sorted() %}
                                {% set assigned_lines = namespace(items=[]) %}
                                {% for driver in assigned_drivers %}
                                    {% set _ = assigned_lines.items.append(driver.formatted_driver_number() ~ ' - ' ~ driver.formatted_name()) %}
                                {% endfor %}
                                <span class="badge bg-primary fs-6 drivers-tooltip"
                                      data-bs-toggle="tooltip"
                                      data-bs-html="true"
                                      title="{% if assigned_lines.items %}{{ assigned_lines.items|join('<br>') }}{% else %}No drivers assigned{% endif %}">
                                    {{ assigned_drivers|length }} drivers
                                </span>
                            </td>
                            <td>
                                <small class="text-muted">{{ pattern.created_at.strftime('%d/%m/%Y') }}</small>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-primary js-edit-pattern"
                                            data-pattern-id="{{ pattern.id }}" title="Edit Pattern">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-success js-copy-pattern"
                                            data-pattern-id="{{ pattern.id }}" title="Copy Pattern">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger js-delete-pattern"
                                            data-pattern-id="{{ pattern.id }}"
                                            data-pattern-name="{{ pattern.name|e }}"
                                            title="Delete Pattern">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

{% else %}
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-week"></i> Shift Patterns</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createPatternModal">
                    <i class="fas fa-plus"></i> Create Pattern
                </button>
            </div>
        </div>
        <div class="card-body text-center py-5">
            <i class="fas fa-calendar-plus fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">No Shift Patterns Created</h3>
            <p class="text-muted mb-4">Create reusable shift patterns that can be assigned to drivers.</p>
            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createPatternModal">
                <i class="fas fa-plus"></i> Create First Pattern
            </button>
        </div>
    </div>
{% endif %}

<!-- Info Card -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card bg-light">
            <div class="card-body">
                <h5><i class="fas fa-lightbulb text-warning"></i> How Shift Patterns Work</h5>
                <div class="row">
                    <div class="col-md-4">
                        <h6>1. Create Patterns</h6>
                        <p class="small text-muted">Define recurring shift cycles (e.g., 7-day, 14-day rotations) with different shift types for each day.</p>
                    </div>
                    <div class="col-md-4">
                        <h6>2. Assign to Drivers</h6>
                        <p class="small text-muted">Assign patterns to drivers with start/end dates. One driver can have different patterns over time.</p>
                    </div>
                    <div class="col-md-4">
                        <h6>3. Generate Daily Sheets</h6>
                        <p class="small text-muted">Daily sheets automatically show which drivers work based on their assigned patterns.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Pattern Modal -->
<div class="modal fade" id="editPatternModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Shift Pattern</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPatternForm">
                    <input type="hidden" id="editPatternId" name="pattern_id">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="editName" class="form-label">Pattern Name *</label>
                                <input type="text" class="form-control" id="editName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editCycleLength" class="form-label">Cycle Length *</label>
                                <select class="form-select" id="editCycleLength" name="cycle_length" required onchange="updateEditPatternDays()">
                                    <option value="7">7 days</option>
                                    <option value="8">8 days</option>
                                    <option value="14">14 days</option>
                                    <option value="16">16 days</option>
                                    <option value="21">21 days</option>
                                    <option value="24">24 days</option>
                                    <option value="28">28 days</option>
                                    <option value="32">32 days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div id="editPatternDays">
                        <h6>Daily Shift Assignment</h6>
                        <div id="editPatternDaysContainer" class="row">
                            <!-- Days populated by JavaScript -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePattern()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the shift pattern <strong><span id="patternName"></span></strong>?</p>
                <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> This will also remove all driver assignments using this pattern.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete Pattern</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Pattern Detail Modal -->
<div class="modal fade" id="patternModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pattern Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="patternDetails"></div>
            </div>
        </div>
    </div>
</div>

<!-- Shift Types Management Modal -->
<div class="modal fade" id="shiftTypesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Shift Types & Times</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="shiftTypesFeedback" class="alert d-none" role="alert"></div>
                <form id="shiftTypesForm">
                    <div class="row" id="shiftTypesGrid">
                        {% for timing in all_timings %}
                        <div class="col-md-6 col-lg-4 mb-4" id="shift-card-{{ timing.shift_type }}">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">{{ timing.shift_type.replace('_', ' ').title() }}</h6>
                                    {% if timing.shift_type not in ['earlies', 'days', 'lates', 'nights'] %}
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteShiftType('{{ timing.shift_type }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label for="{{ timing.shift_type }}_start" class="form-label">Start</label>
                                        <input type="time" class="form-control" id="{{ timing.shift_type }}_start"
                                               name="{{ timing.shift_type }}_start" value="{{ timing.start_time.strftime('%H:%M') }}" required>
                                    </div>
                                    <div class="col-6">
                                        <label for="{{ timing.shift_type }}_end" class="form-label">End</label>
                                        <input type="time" class="form-control" id="{{ timing.shift_type }}_end"
                                               name="{{ timing.shift_type }}_end" value="{{ timing.end_time.strftime('%H:%M') }}" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> End time can be next day if it is earlier than start time.
                    </div>
                </form>

                <hr>

                <form id="newShiftTypeForm">
                    <h6><i class="fas fa-plus"></i> Add New Shift Type</h6>
                    <div class="row align-items-end">
                        <div class="col-md-4 mb-2">
                            <label for="new_shift_type" class="form-label">Name</label>
                            <input type="text" class="form-control" id="new_shift_type" name="shift_type" placeholder="e.g. afternoons" required>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="new_shift_start" class="form-label">Start</label>
                            <input type="time" class="form-control" id="new_shift_start" name="start_time" required>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="new_shift_end" class="form-label">End</label>
                            <input type="time" class="form-control" id="new_shift_end" name="end_time" required>
                        </div>
                        <div class="col-md-2 mb-2">
                            <button type="button" class="btn btn-success w-100" onclick="addShiftType()">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveShiftTypes()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Copy Pattern Modal -->
<div class="modal fade" id="copyPatternModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Copy Shift Pattern</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Creating a copy of an existing pattern</p>
                <form id="copyPatternForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="copyName" class="form-label">Pattern Name *</label>
                                <input type="text" class="form-control" id="copyName" name="name" required 
                                       placeholder="e.g., Standard 7-Day, Night Shift Rotation">
                                <div class="form-text">Give this pattern a descriptive name</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="copyCycleLength" class="form-label">Cycle Length (Days) *</label>
                                <select class="form-select" id="copyCycleLength" name="cycle_length" required onchange="updateCopyPatternDays()">
                                    <option value="">Select</option>
                                    <option value="7">7 days (1 week)</option>
                                    <option value="8">8 days</option>
                                    <option value="14">14 days (2 weeks)</option>
                                    <option value="16">16 days</option>
                                    <option value="21">21 days (3 weeks)</option>
                                    <option value="24">24 days</option>
                                    <option value="28">28 days (4 weeks)</option>
                                    <option value="32">32 days</option>
                                </select>
                                <div class="form-text">How many days before pattern repeats</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="copyDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="copyDescription" name="description" rows="2" 
                                  placeholder="Optional description of this shift pattern..."></textarea>
                    </div>
                    
                    <div id="copyPatternDays" style="display: none;">
                        <hr>
                        <h6><i class="fas fa-calendar"></i> Daily Shift Assignment</h6>
                        <p class="text-muted small">Set the shift type for each day of the cycle:</p>
                        <div id="copyPatternDaysContainer" class="row">
                            <!-- Days populated by JavaScript -->
                        </div>
                        
                        <div class="mt-3">
                            <h6 class="small">Shift Types:</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-warning"><i class="fas fa-sun"></i> Earlies</span>
                                <span class="badge bg-success"><i class="fas fa-sun"></i> Days</span>
                                <span class="badge bg-info"><i class="fas fa-moon"></i> Lates</span>
                                <span class="badge bg-dark"><i class="fas fa-moon"></i> Nights</span>
                                <span class="badge bg-secondary"><i class="fas fa-bed"></i> Day Off</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="copyPatternBtn" onclick="saveCopyPattern()">Create Copy</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Pattern Modal -->
<div class="modal fade" id="createPatternModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Shift Pattern</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPatternForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="createName" class="form-label">Pattern Name *</label>
                                <input type="text" class="form-control" id="createName" name="name" required 
                                       placeholder="e.g., Standard 7-Day, Night Shift Rotation">
                                <div class="form-text">Give this pattern a descriptive name</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="createCycleLength" class="form-label">Cycle Length (Days) *</label>
                                <select class="form-select" id="createCycleLength" name="cycle_length" required onchange="updateCreatePatternDays()">
                                    <option value="">Select</option>
                                    <option value="7">7 days (1 week)</option>
                                    <option value="8">8 days</option>
                                    <option value="14">14 days (2 weeks)</option>
                                    <option value="16">16 days</option>
                                    <option value="21">21 days (3 weeks)</option>
                                    <option value="24">24 days</option>
                                    <option value="28">28 days (4 weeks)</option>
                                    <option value="32">32 days</option>
                                </select>
                                <div class="form-text">How many days before pattern repeats</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="createDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="createDescription" name="description" rows="2" 
                                  placeholder="Optional description of this shift pattern..."></textarea>
                    </div>
                    
                    <div id="createPatternDays" style="display: none;">
                        <hr>
                        <h6><i class="fas fa-calendar"></i> Daily Shift Assignment</h6>
                        <p class="text-muted small">Set the shift type for each day of the cycle:</p>
                        <div id="createPatternDaysContainer" class="row">
                            <!-- Days populated by JavaScript -->
                        </div>
                        
                        <div class="mt-3">
                            <h6 class="small">Shift Types:</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-warning"><i class="fas fa-sun"></i> Earlies</span>
                                <span class="badge bg-success"><i class="fas fa-sun"></i> Days</span>
                                <span class="badge bg-info"><i class="fas fa-moon"></i> Lates</span>
                                <span class="badge bg-dark"><i class="fas fa-moon"></i> Nights</span>
                                <span class="badge bg-secondary"><i class="fas fa-bed"></i> Day Off</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createPatternBtn" onclick="saveCreatePattern()" disabled>Create Pattern</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function getCurrentShiftTypes() {
    const form = document.getElementById('shiftTypesForm');
    if (!form) return ['earlies', 'days', 'lates', 'nights'];

    const types = [];
    form.querySelectorAll('input[name$="_start"]').forEach((input) => {
        types.push(input.name.replace(/_start$/, ''));
    });

    return types.length ? types : ['earlies', 'days', 'lates', 'nights'];
}

function buildShiftTypeOptions(selectedValue = '') {
    const shiftTypes = getCurrentShiftTypes();
    return shiftTypes.map((type) => {
        const selected = selectedValue === type ? 'selected' : '';
        const label = type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        return `<option value="${type}" ${selected}>${label}</option>`;
    }).join('');
}

function getShiftIconClass(shiftType) {
    if (shiftType === 'earlies') return 'fa-sun text-warning';
    if (shiftType === 'days') return 'fa-sun text-success';
    if (shiftType === 'lates') return 'fa-moon text-info';
    if (shiftType === 'nights') return 'fa-moon text-dark';
    return 'fa-clock text-primary';
}

function toTitleCase(value) {
    return value.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
}

function syncCurrentShiftsCard(shiftType, startTime, endTime) {
    const currentGrid = document.getElementById('currentShiftsGrid');
    if (!currentGrid) return;

    let card = currentGrid.querySelector(`.current-shift-card[data-shift-type="${shiftType}"]`);
    if (!card) {
        card = document.createElement('div');
        card.className = 'col-md-3 current-shift-card';
        card.setAttribute('data-shift-type', shiftType);
        currentGrid.appendChild(card);
    }

    card.setAttribute('data-start-time', startTime);
    const iconClass = getShiftIconClass(shiftType);
    const label = toTitleCase(shiftType);
    card.innerHTML = `
        <div class="text-center p-3 border rounded">
            <i class="fas ${iconClass} fa-2x mb-2"></i>
            <h6>${label}</h6>
            <p class="mb-0"><strong>${startTime} - ${endTime}</strong></p>
        </div>
    `;

    const cards = Array.from(currentGrid.querySelectorAll('.current-shift-card'));
    cards.sort((a, b) => (a.getAttribute('data-start-time') || '').localeCompare(b.getAttribute('data-start-time') || ''));
    cards.forEach(sortedCard => currentGrid.appendChild(sortedCard));
}

function removeCurrentShiftsCard(shiftType) {
    const currentGrid = document.getElementById('currentShiftsGrid');
    if (!currentGrid) return;
    const card = currentGrid.querySelector(`.current-shift-card[data-shift-type="${shiftType}"]`);
    if (card) {
        card.remove();
    }
}

let shiftTimesBaseline = {};

function captureShiftTimesBaseline() {
    const form = document.getElementById('shiftTypesForm');
    if (!form) return;

    const baseline = {};
    form.querySelectorAll('input[name$="_start"], input[name$="_end"]').forEach((input) => {
        baseline[input.name] = input.value;
    });
    shiftTimesBaseline = baseline;
}

function restoreShiftTimesFromBaseline() {
    const form = document.getElementById('shiftTypesForm');
    if (!form) return;

    form.querySelectorAll('input[name$="_start"], input[name$="_end"]').forEach((input) => {
        if (Object.prototype.hasOwnProperty.call(shiftTimesBaseline, input.name)) {
            input.value = shiftTimesBaseline[input.name];
        }
    });
}

let shiftTypesFeedbackTimer = null;

function showShiftTypesFeedback(type, message) {
    const feedback = document.getElementById('shiftTypesFeedback');
    if (!feedback) return;

    if (shiftTypesFeedbackTimer) {
        clearTimeout(shiftTypesFeedbackTimer);
        shiftTypesFeedbackTimer = null;
    }

    feedback.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning', 'alert-info');
    feedback.classList.remove('fade', 'show');
    feedback.classList.add(`alert-${type}`);
    feedback.textContent = message;

    feedback.classList.add('fade', 'show');

    shiftTypesFeedbackTimer = setTimeout(() => {
        feedback.classList.remove('show');
        setTimeout(() => {
            feedback.classList.add('d-none');
            feedback.classList.remove('fade');
            feedback.textContent = '';
        }, 300);
    }, 10000);
}

function showMainPageFeedback(type, message) {
    const feedback = document.getElementById('mainPageFeedback');
    if (!feedback) return;

    feedback.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning', 'alert-info', 'fade', 'show');
    feedback.classList.add(`alert-${type}`, 'fade', 'show');
    feedback.textContent = message;

    setTimeout(() => {
        feedback.classList.remove('show');
        setTimeout(() => {
            feedback.classList.add('d-none');
            feedback.classList.remove('fade');
            feedback.textContent = '';
        }, 300);
    }, 10000);
}

function setPendingMainFeedback(type, message) {
    try {
        sessionStorage.setItem('pendingMainFeedback', JSON.stringify({ type, message }));
    } catch (error) {
        console.warn('Could not store pending feedback:', error);
    }
}

function flushPendingMainFeedback() {
    try {
        const raw = sessionStorage.getItem('pendingMainFeedback');
        if (!raw) return;

        sessionStorage.removeItem('pendingMainFeedback');
        const payload = JSON.parse(raw);
        if (payload && payload.type && payload.message) {
            showMainPageFeedback(payload.type, payload.message);
        }
    } catch (error) {
        console.warn('Could not load pending feedback:', error);
    }
}

// Create pattern management
function updateCreatePatternDays() {
    const cycleLength = parseInt(document.getElementById('createCycleLength').value);
    const container = document.getElementById('createPatternDaysContainer');
    const section = document.getElementById('createPatternDays');
    const submitBtn = document.getElementById('createPatternBtn');
    
    if (!cycleLength) {
        section.style.display = 'none';
        submitBtn.disabled = true;
        return;
    }
    
    section.style.display = 'block';
    submitBtn.disabled = false;
    container.innerHTML = '';
    
    for (let i = 0; i < cycleLength; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'col-md-3 mb-3';
        
        dayDiv.innerHTML = `
            <label for="create_day_${i}_shift" class="form-label">${dayNames[i]}</label>
            <select class="form-select" id="create_day_${i}_shift" name="day_${i}_shift" required>
                <option value="day_off">Day Off</option>
                ${buildShiftTypeOptions()}
            </select>
        `;
        
        container.appendChild(dayDiv);
    }
    
    // Add text formatting to name field
    const nameInput = document.getElementById('createName');
    if (nameInput && !nameInput.hasFormattingListener) {
        nameInput.addEventListener('input', function(e) {
            const input = e.target;
            const cursorPosition = input.selectionStart;
            const value = input.value;
            
            const titleCase = value.toLowerCase().replace(/\\b\\w/g, function(char) {
                return char.toUpperCase();
            });
            
            input.value = titleCase;
            input.setSelectionRange(cursorPosition, cursorPosition);
        });
        nameInput.hasFormattingListener = true;
    }
    
    // Add text formatting to description field
    const descInput = document.getElementById('createDescription');
    if (descInput && !descInput.hasFormattingListener) {
        descInput.addEventListener('input', function(e) {
            const input = e.target;
            const cursorPosition = input.selectionStart;
            let value = input.value;
            
            value = value.toLowerCase().replace(/(^|\\. )(\\w)/g, function(match, p1, p2) {
                return p1 + p2.toUpperCase();
            });
            
            input.value = value;
            input.setSelectionRange(cursorPosition, cursorPosition);
        });
        descInput.hasFormattingListener = true;
    }
}

function saveCreatePattern() {
    const form = document.getElementById('createPatternForm');
    const formData = new FormData(form);
    
    // Add daily shift data
    const cycleLength = parseInt(document.getElementById('createCycleLength').value);
    for (let i = 0; i < cycleLength; i++) {
        const select = document.getElementById(`create_day_${i}_shift`);
        if (select) {
            formData.append(`day_${i}_shift`, select.value);
        }
    }
    
    fetch('/shift-pattern/add', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(async response => {
        let data;
        try {
            data = await response.json();
        } catch {
            data = { success: false, error: `HTTP ${response.status}` };
        }
        if (!response.ok) {
            return { success: false, error: data.error || `HTTP ${response.status}` };
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            var modal = bootstrap.Modal.getInstance(document.getElementById('createPatternModal'));
            modal.hide();
            setPendingMainFeedback('success', 'Shift pattern added successfully.');
            location.reload(); // Refresh page to show updated data
        } else {
            showMainPageFeedback('danger', 'Error creating pattern: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error creating pattern:', error);
        showMainPageFeedback('danger', 'Error creating pattern.');
    });
}

// Shift types management
function addShiftType() {
    const form = document.getElementById('newShiftTypeForm');
    const formData = new FormData(form);

    const rawName = (formData.get('shift_type') || '').toString().trim().toLowerCase();
    const shiftType = rawName.replace(/\s+/g, '_');
    const startTime = formData.get('start_time');
    const endTime = formData.get('end_time');

    if (!shiftType || !startTime || !endTime) {
        showShiftTypesFeedback('danger', 'Please fill in all new shift type fields.');
        return;
    }

    if (!/^[a-z0-9_]+$/.test(shiftType)) {
        showShiftTypesFeedback('danger', 'Shift type name can only contain letters, numbers, and underscores.');
        return;
    }

    formData.set('shift_type', shiftType);

    fetch('/shift-types/add', {
        method: 'POST',
        body: formData
    })
    .then(async response => {
        let data;
        try {
            data = await response.json();
        } catch {
            data = { success: false, error: `HTTP ${response.status}` };
        }
        if (!response.ok) {
            return { success: false, error: data.error || `HTTP ${response.status}` };
        }
        return data;
    })
    .then(data => {
        if (!data.success) {
            showShiftTypesFeedback('danger', 'Error adding shift type: ' + (data.error || 'Unknown error'));
            return;
        }

        const existingCard = document.getElementById(`shift-card-${shiftType}`);
        if (!existingCard) {
            const grid = document.getElementById('shiftTypesGrid');
            const card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4 mb-4';
            card.id = `shift-card-${shiftType}`;
            const label = toTitleCase(shiftType);

            card.innerHTML = `
                <div class="border rounded p-3 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">${label}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteShiftType('${shiftType}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label for="${shiftType}_start" class="form-label">Start</label>
                            <input type="time" class="form-control" id="${shiftType}_start" name="${shiftType}_start" value="${startTime}" required>
                        </div>
                        <div class="col-6">
                            <label for="${shiftType}_end" class="form-label">End</label>
                            <input type="time" class="form-control" id="${shiftType}_end" name="${shiftType}_end" value="${endTime}" required>
                        </div>
                    </div>
                </div>
            `;

            grid.appendChild(card);
        }

        syncCurrentShiftsCard(shiftType, startTime, endTime);
        captureShiftTimesBaseline();

        form.reset();
        showShiftTypesFeedback('success', 'Shift type added successfully.');
    })
    .catch(error => {
        console.error('Error adding shift type:', error);
        showShiftTypesFeedback('danger', 'Error adding shift type.');
    });
}

function deleteShiftType(shiftType) {
    if (!confirm(`Delete shift type "${shiftType}"?`)) {
        return;
    }

    fetch(`/shift-types/delete/${shiftType}`, {
        method: 'POST'
    })
    .then(async response => {
        let data;
        try {
            data = await response.json();
        } catch {
            data = { success: false, error: `HTTP ${response.status}` };
        }
        if (!response.ok) {
            return { success: false, error: data.error || `HTTP ${response.status}` };
        }
        return data;
    })
    .then(data => {
        if (!data.success) {
            showShiftTypesFeedback('danger', 'Error deleting shift type: ' + (data.error || 'Unknown error'));
            return;
        }

        const card = document.getElementById(`shift-card-${shiftType}`);
        if (card) {
            card.remove();
        }

        removeCurrentShiftsCard(shiftType);
        captureShiftTimesBaseline();
        showShiftTypesFeedback('success', 'Shift type deleted successfully.');
    })
    .catch(error => {
        console.error('Error deleting shift type:', error);
        showShiftTypesFeedback('danger', 'Error deleting shift type.');
    });
}

function saveShiftTypes() {
    const form = document.getElementById('shiftTypesForm');
    const formData = new FormData(form);
    
    fetch('/shift-types/update', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const startInputs = form.querySelectorAll('input[name$="_start"]');
            startInputs.forEach((startInput) => {
                const shiftType = startInput.name.replace(/_start$/, '');
                const endInput = form.querySelector(`input[name="${shiftType}_end"]`);
                if (endInput) {
                    syncCurrentShiftsCard(shiftType, startInput.value, endInput.value);
                }
            });
            captureShiftTimesBaseline();

            const modal = bootstrap.Modal.getInstance(document.getElementById('shiftTypesModal'));
            if (modal) {
                modal.hide();
            }

            showMainPageFeedback('success', 'Shift times saved successfully.');
        } else {
            showShiftTypesFeedback('danger', 'Error saving shift types: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving shift types:', error);
        showShiftTypesFeedback('danger', 'Error saving shift types.');
    });
}

const dayNames = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7',
                  'Day 8', 'Day 9', 'Day 10', 'Day 11', 'Day 12', 'Day 13', 'Day 14',
                  'Day 15', 'Day 16', 'Day 17', 'Day 18', 'Day 19', 'Day 20', 'Day 21',
                  'Day 22', 'Day 23', 'Day 24', 'Day 25', 'Day 26', 'Day 27', 'Day 28',
                  'Day 29', 'Day 30', 'Day 31', 'Day 32'];

function confirmDelete(patternId, patternName) {
    document.getElementById('patternName').textContent = patternName;
    document.getElementById('deleteForm').action = `/shift-pattern/${patternId}/delete`;
    
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

function editPattern(patternId) {
    // Fetch pattern data and populate edit form
    fetch(`/shift-pattern/${patternId}/edit-data`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('editPatternId').value = data.id;
            document.getElementById('editName').value = data.name;
            document.getElementById('editDescription').value = data.description || '';
            document.getElementById('editCycleLength').value = data.cycle_length;
            
            // Store pattern data for use in updateEditPatternDays
            window.currentEditPatternData = data.pattern_data;
            updateEditPatternDays();
            
            var editModal = new bootstrap.Modal(document.getElementById('editPatternModal'));
            editModal.show();
        })
        .catch(error => {
            console.error('Error fetching pattern data:', error);
            alert('Error loading pattern data');
        });
}

function updateEditPatternDays() {
    const cycleLength = parseInt(document.getElementById('editCycleLength').value);
    const container = document.getElementById('editPatternDaysContainer');
    
    container.innerHTML = '';
    
    for (let i = 0; i < cycleLength; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'col-md-3 mb-3';
        
        // Get existing value if available
        const currentValue = (window.currentEditPatternData && window.currentEditPatternData[i]) ? window.currentEditPatternData[i] : 'day_off';
        
        dayDiv.innerHTML = `
            <label for="edit_day_${i}_shift" class="form-label">${dayNames[i]}</label>
            <select class="form-select" id="edit_day_${i}_shift" name="day_${i}_shift" required>
                <option value="day_off" ${currentValue === 'day_off' ? 'selected' : ''}>Day Off</option>
                ${buildShiftTypeOptions(currentValue)}
            </select>
        `;
        
        container.appendChild(dayDiv);
    }
    
    // Add text formatting to name field
    const nameInput = document.getElementById('editName');
    if (nameInput && !nameInput.hasFormattingListener) {
        nameInput.addEventListener('input', function(e) {
            const input = e.target;
            const cursorPosition = input.selectionStart;
            const value = input.value;
            
            const titleCase = value.toLowerCase().replace(/\b\w/g, function(char) {
                return char.toUpperCase();
            });
            
            input.value = titleCase;
            input.setSelectionRange(cursorPosition, cursorPosition);
        });
        nameInput.hasFormattingListener = true;
    }
    
    // Add text formatting to description field
    const descInput = document.getElementById('editDescription');
    if (descInput && !descInput.hasFormattingListener) {
        descInput.addEventListener('input', function(e) {
            const input = e.target;
            const cursorPosition = input.selectionStart;
            let value = input.value;
            
            value = value.toLowerCase().replace(/(^|\. )(\w)/g, function(match, p1, p2) {
                return p1 + p2.toUpperCase();
            });
            
            input.value = value;
            input.setSelectionRange(cursorPosition, cursorPosition);
        });
        descInput.hasFormattingListener = true;
    }
}

function savePattern() {
    const form = document.getElementById('editPatternForm');
    const formData = new FormData(form);
    
    // Add daily shift data
    const cycleLength = parseInt(document.getElementById('editCycleLength').value);
    for (let i = 0; i < cycleLength; i++) {
        const select = document.getElementById(`edit_day_${i}_shift`);
        if (select) {
            formData.append(`day_${i}_shift`, select.value);
        }
    }
    
    const patternId = document.getElementById('editPatternId').value;
    
    fetch(`/shift-pattern/${patternId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editPatternModal'));
            if (editModal) {
                editModal.hide();
            }
            setPendingMainFeedback('success', 'Shift pattern updated successfully.');
            location.reload(); // Refresh page to show updated data
        } else {
            showMainPageFeedback('danger', 'Error saving pattern: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving pattern:', error);
        showMainPageFeedback('danger', 'Error saving pattern.');
    });
}

function updateCopyPatternDays() {
    const select = document.getElementById('copyCycleLength');
    const container = document.getElementById('copyPatternDaysContainer');
    const daysSection = document.getElementById('copyPatternDays');
    
    if (select.value && parseInt(select.value) > 0) {
        const days = parseInt(select.value);
        daysSection.style.display = 'block';
        container.innerHTML = '';
        
        for (let i = 0; i < days; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'col-md-3 mb-3';
            dayDiv.innerHTML = `
                <label for="copyDay${i}" class="form-label">${dayNames[i]}</label>
                <select class="form-select" id="copyDay${i}" name="day_${i}_shift">
                    <option value="day_off">Day Off</option>
                    ${buildShiftTypeOptions()}
                </select>
            `;
            container.appendChild(dayDiv);
        }
    } else {
        daysSection.style.display = 'none';
    }
}

function copyPattern(patternId) {
    // Fetch pattern data
    fetch(`/shift-pattern/${patternId}/edit-data`)
        .then(async response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || !Array.isArray(data.pattern_data)) {
                alert('Error loading pattern data: invalid response');
                return;
            }
            
            try {
                // Pre-fill form with pattern data
                document.getElementById('copyName').value = `${data.name} (Copy)`;
                document.getElementById('copyDescription').value = data.description || '';
                document.getElementById('copyCycleLength').value = data.cycle_length;
                
                // Store pattern data for setting day values
                window.currentCopyPatternData = data.pattern_data;
                updateCopyPatternDays();
                
                // Wait for DOM update then set day values
                setTimeout(() => {
                    if (window.currentCopyPatternData) {
                        for (let i = 0; i < data.cycle_length; i++) {
                            const select = document.getElementById(`copyDay${i}`);
                            if (select && window.currentCopyPatternData[i]) {
                                select.value = window.currentCopyPatternData[i];
                            }
                        }
                    }
                }, 100);
                
                // Show modal
                new bootstrap.Modal(document.getElementById('copyPatternModal')).show();
            } catch (uiError) {
                console.error('UI error while preparing copy modal:', uiError);
                alert('Error loading pattern data: failed to prepare copy form');
            }
        })
        .catch(error => {
            console.error('Error fetching pattern:', error);
            alert('Error loading pattern data: request failed');
        });
}

function saveCopyPattern() {
    const form = document.getElementById('copyPatternForm');
    const formData = new FormData(form);
    
    if (!formData.get('name') || !formData.get('cycle_length')) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Add daily shift data
    const cycleLength = parseInt(formData.get('cycle_length'));
    for (let i = 0; i < cycleLength; i++) {
        const select = document.getElementById(`copyDay${i}`);
        if (select) {
            formData.append(`day_${i}_shift`, select.value);
        }
    }
    
    document.getElementById('copyPatternBtn').disabled = true;
    document.getElementById('copyPatternBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    
    fetch('/shift-pattern/add', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(async response => {
        let data;
        try {
            data = await response.json();
        } catch {
            data = { success: false, error: `HTTP ${response.status}` };
        }
        if (!response.ok) {
            return { success: false, error: data.error || `HTTP ${response.status}` };
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            var modal = bootstrap.Modal.getInstance(document.getElementById('copyPatternModal'));
            modal.hide();
            form.reset();
            document.getElementById('copyPatternDays').style.display = 'none';
            setPendingMainFeedback('success', 'Shift pattern copied successfully.');
            location.reload(); // Reload to show new pattern
        } else {
            showMainPageFeedback('danger', 'Error creating pattern copy: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMainPageFeedback('danger', 'Error creating pattern copy.');
    })
    .finally(() => {
        document.getElementById('copyPatternBtn').disabled = false;
        document.getElementById('copyPatternBtn').innerHTML = 'Create Copy';
    });
}

function viewPattern(patternId) {
    // This would fetch pattern details via AJAX in a real implementation
    document.getElementById('patternDetails').innerHTML = `
        <p class="text-muted">Pattern details would be loaded here...</p>
    `;
    
    var patternModal = new bootstrap.Modal(document.getElementById('patternModal'));
    patternModal.show();
}

function resetNewShiftTypeForm() {
    restoreShiftTimesFromBaseline();

    const form = document.getElementById('newShiftTypeForm');
    if (form) {
        form.reset();
    }

    const feedback = document.getElementById('shiftTypesFeedback');
    if (feedback) {
        feedback.classList.add('d-none');
        feedback.textContent = '';
        feedback.classList.remove('alert-success', 'alert-danger', 'alert-warning', 'alert-info', 'fade', 'show');
    }

    if (shiftTypesFeedbackTimer) {
        clearTimeout(shiftTypesFeedbackTimer);
        shiftTypesFeedbackTimer = null;
    }
}

const shiftTypesModalEl = document.getElementById('shiftTypesModal');
if (shiftTypesModalEl) {
    shiftTypesModalEl.addEventListener('show.bs.modal', captureShiftTimesBaseline);
    shiftTypesModalEl.addEventListener('hidden.bs.modal', resetNewShiftTypeForm);
}

document.querySelectorAll('.drivers-tooltip[data-bs-toggle="tooltip"]').forEach((element) => {
    new bootstrap.Tooltip(element);
});

document.querySelectorAll('.js-edit-pattern').forEach((button) => {
    button.addEventListener('click', () => {
        const patternId = parseInt(button.dataset.patternId, 10);
        if (!Number.isNaN(patternId)) {
            editPattern(patternId);
        }
    });
});

document.querySelectorAll('.js-copy-pattern').forEach((button) => {
    button.addEventListener('click', () => {
        const patternId = parseInt(button.dataset.patternId, 10);
        if (!Number.isNaN(patternId)) {
            copyPattern(patternId);
        }
    });
});

document.querySelectorAll('.js-delete-pattern').forEach((button) => {
    button.addEventListener('click', () => {
        const patternId = parseInt(button.dataset.patternId, 10);
        const patternName = button.dataset.patternName || '';
        if (!Number.isNaN(patternId)) {
            confirmDelete(patternId, patternName);
        }
    });
});

const deleteForm = document.getElementById('deleteForm');
if (deleteForm) {
    deleteForm.addEventListener('submit', function(event) {
        event.preventDefault();

        fetch(deleteForm.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(async response => {
            let data;
            try {
                data = await response.json();
            } catch {
                data = { success: false, error: `HTTP ${response.status}` };
            }
            if (!response.ok) {
                return { success: false, error: data.error || `HTTP ${response.status}` };
            }
            return data;
        })
        .then(data => {
            if (data.success) {
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                if (deleteModal) {
                    deleteModal.hide();
                }
                setPendingMainFeedback('success', 'Shift pattern deleted successfully.');
                location.reload();
            } else {
                showMainPageFeedback('danger', 'Error deleting pattern: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting pattern:', error);
            showMainPageFeedback('danger', 'Error deleting pattern.');
        });
    });
}

flushPendingMainFeedback();
</script>
{% endblock %}